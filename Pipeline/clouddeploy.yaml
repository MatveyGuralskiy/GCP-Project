apiVersion: deploy.cloud.google.com/v1
kind: DeliveryPipeline
metadata:
  name: my-run-pipeline
  description: Cloud Run application pipeline
serialPipeline:
  stages:
    - targetId: run-production-1
    - targetId: run-production-2

---
apiVersion: deploy.cloud.google.com/v1
kind: Target
metadata:
  name: run-production-1
  description: "Cloud Run Production Target 1"
run:
  location: ${_REGION}
  customTargetType: cloud-run-autoscaling

---
apiVersion: deploy.cloud.google.com/v1
kind: Target
metadata:
  name: run-production-2
  description: "Cloud Run Production Target 2"
run:
  location: ${_REGION}
  customTargetType: cloud-run-autoscaling
---
apiVersion: serving.knative.dev/v1
kind: Service
metadata:
  name: matvey-cloud-run-service
spec:
  template:
    spec:
      containers:
        - image: ${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPOSITORY_NAME}/app-1:V1.0
          resources:
            limits:
              cpu: 1
              memory: 256Mi
          timeoutSeconds: 60
      maxInstanceCount: 5
      minInstanceCount: 2
  traffic:
    - percent: 100
      latestRevision: true
